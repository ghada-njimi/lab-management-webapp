<div class="publications-container">
  <!-- Header -->
  <div class="publications-header">
    <h2>üìö Gestion des Publications</h2>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="newPublication()">
        <mat-icon>add_circle</mat-icon>
        Nouvelle Publication
      </button>
      <button mat-raised-button color="accent" (click)="showStatistics()">
        <mat-icon>bar_chart</mat-icon>
        Statistiques
      </button>
      <button mat-raised-button (click)="exportToCSV()">
        <mat-icon>download</mat-icon>
        Exporter CSV
      </button>
    </div>
  </div>

  <!-- Recherche -->
  <div class="search-section">
    <form [formGroup]="searchForm" (ngSubmit)="onSearch()" class="search-form">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Rechercher une publication</mat-label>
        <input matInput formControlName="searchTerm" placeholder="Titre, auteurs...">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
      <button mat-raised-button color="primary" type="submit">
        Rechercher
      </button>
    </form>
  </div>

  <!-- Filtres -->
  <div class="filters-section">
    <h3>Filtrer les publications</h3>
    <form [formGroup]="filterForm" class="filters-form">
      <div class="filter-grid">
        <mat-form-field appearance="outline">
          <mat-label>Type de publication</mat-label>
          <mat-select formControlName="type">
            <mat-option value="">Tous les types</mat-option>
            <mat-option *ngFor="let type of publicationTypes" [value]="type">
              {{type}}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Ann√©e</mat-label>
          <mat-select formControlName="year">
            <mat-option value="">Toutes les ann√©es</mat-option>
            <mat-option *ngFor="let year of years" [value]="year">
              {{year}}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Date d√©but</mat-label>
          <input matInput [matDatepicker]="pickerStart" formControlName="startDate">
          <mat-datepicker-toggle matSuffix [for]="pickerStart"></mat-datepicker-toggle>
          <mat-datepicker #pickerStart></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Date fin</mat-label>
          <input matInput [matDatepicker]="pickerEnd" formControlName="endDate">
          <mat-datepicker-toggle matSuffix [for]="pickerEnd"></mat-datepicker-toggle>
          <mat-datepicker #pickerEnd></mat-datepicker>
        </mat-form-field>
      </div>
      
      <div class="filter-buttons">
        <button mat-raised-button color="primary" (click)="onFilter()">
          <mat-icon>filter_list</mat-icon>
          Appliquer filtres
        </button>
        <button mat-button (click)="resetFilters()">
          <mat-icon>refresh</mat-icon>
          R√©initialiser
        </button>
      </div>
    </form>
  </div>

  <!-- Message d'erreur -->
  <div *ngIf="errorMessage" class="error-message">
    <mat-icon>error_outline</mat-icon>
    {{errorMessage}}
  </div>

  <!-- Formulaire d'√©dition/cr√©ation -->
  <div *ngIf="isEditMode || !selectedPublication" class="form-section">
    <h3>{{isEditMode ? 'Modifier' : 'Nouvelle'}} Publication</h3>
    <form [formGroup]="publicationForm" (ngSubmit)="savePublication()" class="publication-form">
      <div class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Titre *</mat-label>
          <input matInput formControlName="titre" required>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Type *</mat-label>
          <mat-select formControlName="type" required>
            <mat-option *ngFor="let type of publicationTypes" [value]="type">
              {{type}}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Date d'apparition *</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="dateApparition" required>
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Source (Journal/Conf√©rence)</mat-label>
          <input matInput formControlName="source">
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Auteurs *</mat-label>
          <input matInput formControlName="auteurs" required placeholder="S√©par√©s par des virgules">
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Lien (DOI/URL)</mat-label>
          <input matInput formControlName="lien" type="url">
        </mat-form-field>
      </div>

      <div class="form-actions">
        <button mat-raised-button color="primary" type="submit" [disabled]="publicationForm.invalid">
          <mat-icon>save</mat-icon>
          {{isEditMode ? 'Mettre √† jour' : 'Enregistrer'}}
        </button>
        <button mat-button type="button" (click)="newPublication()" *ngIf="isEditMode">
          <mat-icon>close</mat-icon>
          Annuler
        </button>
      </div>
    </form>
  </div>

  <!-- Liste des publications -->
  <div class="list-section">
    <h3>Liste des Publications ({{filteredPublications.length}})</h3>
    
    <div *ngIf="isLoading" class="loading">
      <mat-spinner diameter="40"></mat-spinner>
      <span>Chargement des publications...</span>
    </div>

    <div *ngIf="!isLoading && filteredPublications.length === 0" class="no-data">
      <mat-icon>info</mat-icon>
      <p>Aucune publication trouv√©e</p>
    </div>

    <div *ngIf="!isLoading && filteredPublications.length > 0">
      <!-- Pagination -->
      <div class="pagination-info">
        <span>Page {{currentPage}} sur {{totalPages}} ({{totalItems}} publications)</span>
        <div class="pagination-controls">
          <button mat-icon-button (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1">
            <mat-icon>chevron_left</mat-icon>
          </button>
          <span class="page-numbers">
            <button mat-button *ngFor="let page of [].constructor(totalPages); let i = index"
                    [class.active]="currentPage === i+1"
                    (click)="changePage(i+1)">
              {{i+1}}
            </button>
          </span>
          <button mat-icon-button (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages">
            <mat-icon>chevron_right</mat-icon>
          </button>
        </div>
      </div>

      <!-- Tableau des publications -->
      <div class="publications-table-container">
        <table mat-table [dataSource]="paginatedPublications" class="mat-elevation-z1 publications-table">
          
          <!-- Colonne Titre -->
          <ng-container matColumnDef="titre">
            <th mat-header-cell *matHeaderCellDef>Titre</th>
            <td mat-cell *matCellDef="let pub" class="title-cell">
              <strong>{{pub.titre}}</strong>
              <div class="sub-info">{{pub.type}}</div>
            </td>
          </ng-container>

          <!-- Colonne Auteurs -->
          <ng-container matColumnDef="auteurs">
            <th mat-header-cell *matHeaderCellDef>Auteurs</th>
            <td mat-cell *matCellDef="let pub">
              <span class="authors">{{pub.auteurs}}</span>
            </td>
          </ng-container>

          <!-- Colonne Date -->
          <ng-container matColumnDef="dateApparition">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let pub">
              {{pub.dateApparition | date:'dd/MM/yyyy'}}
            </td>
          </ng-container>

          <!-- Colonne Source -->
          <ng-container matColumnDef="source">
            <th mat-header-cell *matHeaderCellDef>Source</th>
            <td mat-cell *matCellDef="let pub">
              {{pub.source || 'Non sp√©cifi√©'}}
            </td>
          </ng-container>

          <!-- Colonne Actions -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="actions-header">Actions</th>
            <td mat-cell *matCellDef="let pub" class="actions-cell">
              <button mat-icon-button color="primary" (click)="selectPublication(pub)" matTooltip="Modifier">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="deletePublication(pub.id!)" matTooltip="Supprimer">
                <mat-icon>delete</mat-icon>
              </button>
              <a *ngIf="pub.lien" mat-icon-button [href]="pub.lien" target="_blank" matTooltip="Voir le lien">
                <mat-icon>link</mat-icon>
              </a>
            </td>
          </ng-container>

          <!-- Ligne d'en-t√™te -->
          <tr mat-header-row *matHeaderRowDef="['titre', 'auteurs', 'dateApparition', 'source', 'actions']"></tr>
          <!-- Lignes de donn√©es -->
          <tr mat-row *matRowDef="let row; columns: ['titre', 'auteurs', 'dateApparition', 'source', 'actions'];"></tr>

        </table>
      </div>
    </div>
  </div>
</div>